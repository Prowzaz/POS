#!/bin/bash

echo "ðŸš€ à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸£à¸°à¸šà¸šà¸£à¹‰à¸²à¸™à¸‚à¹‰à¸²à¸§à¸¡à¸±à¸™à¹„à¸à¹ˆà¸—à¹‰à¸²à¸¢à¸‹à¸­à¸¢à¹„à¸­à¸¢à¸£à¸² 21"
echo "================================================"

# à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² Node.js à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¹à¸¥à¹‰à¸§à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
if ! command -v node &> /dev/null; then
    echo "âŒ à¹„à¸¡à¹ˆà¸žà¸š Node.js à¸à¸£à¸¸à¸“à¸²à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Node.js à¸à¹ˆà¸­à¸™"
    exit 1
fi

# à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² npm à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¹à¸¥à¹‰à¸§à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
if ! command -v npm &> /dev/null; then
    echo "âŒ à¹„à¸¡à¹ˆà¸žà¸š npm à¸à¸£à¸¸à¸“à¸²à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ npm à¸à¹ˆà¸­à¸™"
    exit 1
fi

echo "âœ… Node.js à¹à¸¥à¸° npm à¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™"

# à¹€à¸‚à¹‰à¸²à¹„à¸›à¹ƒà¸™à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ backend
echo "ðŸ“ à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ backend..."
cd backend

# à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ dependencies
echo "ðŸ“¦ à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ dependencies..."
npm install

# à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ backend server
echo "ðŸ–¥ï¸  à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ backend server..."
echo "   Backend à¸ˆà¸°à¸—à¸³à¸‡à¸²à¸™à¸—à¸µà¹ˆ http://localhost:3001"
echo "   API endpoints:"
echo "   - GET  /api/menu"
echo "   - POST /api/orders"
echo "   - POST /api/promo/validate"
echo "   - GET  /api/orders/:orderNumber/check-payment"
echo "   - POST /api/orders/:orderNumber/payment"
echo ""

# à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ server à¹ƒà¸™à¸žà¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡
npm start &
BACKEND_PID=$!

# à¸£à¸­à¹ƒà¸«à¹‰ backend à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
echo "â³ à¸£à¸­à¹ƒà¸«à¹‰ backend à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™..."
sleep 5

# à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² backend à¸—à¸³à¸‡à¸²à¸™à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
if curl -s http://localhost:3001/health > /dev/null; then
    echo "âœ… Backend server à¸—à¸³à¸‡à¸²à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢"
else
    echo "âŒ Backend server à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¹„à¸”à¹‰"
    kill $BACKEND_PID 2>/dev/null
    exit 1
fi

# à¸à¸¥à¸±à¸šà¹„à¸›à¸—à¸µà¹ˆà¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¸«à¸¥à¸±à¸
cd ..

echo ""
echo "ðŸŒ à¹€à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸šà¹ƒà¸™à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œ..."
echo "   Frontend: file://$(pwd)/frontend/index.html"
echo "   à¸«à¸£à¸·à¸­à¹€à¸›à¸´à¸”à¹„à¸Ÿà¸¥à¹Œ frontend/index.html à¹ƒà¸™à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œ"
echo ""

# à¹€à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸šà¹ƒà¸™à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œ (macOS)
if [[ "$OSTYPE" == "darwin"* ]]; then
    open frontend/index.html
fi

echo "ðŸŽ‰ à¸£à¸°à¸šà¸šà¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™!"
echo ""
echo "ðŸ“‹ à¸§à¸´à¸˜à¸µà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™:"
echo "   1. à¹€à¸¥à¸·à¸­à¸à¹€à¸¡à¸™à¸¹à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£"
echo "   2. à¸à¸”à¸›à¸¸à¹ˆà¸¡ 'à¹€à¸žà¸´à¹ˆà¸¡à¸¥à¸‡à¸•à¸°à¸à¸£à¹‰à¸²'"
echo "   3. à¸à¸”à¹„à¸­à¸„à¸­à¸™à¸•à¸°à¸à¸£à¹‰à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²à¹€à¸žà¸·à¹ˆà¸­à¹„à¸›à¸«à¸™à¹‰à¸² checkout"
echo "   4. à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¥à¸°à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™"
echo ""
echo "ðŸ”§ à¸£à¸«à¸±à¸ªà¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™:"
echo "   - WELCOME10 (à¸ªà¹ˆà¸§à¸™à¸¥à¸” 10%)"
echo "   - SAVE20 (à¸ªà¹ˆà¸§à¸™à¸¥à¸” 20 à¸šà¸²à¸—)"
echo "   - NEWUSER (à¸ªà¹ˆà¸§à¸™à¸¥à¸” 15%)"
echo ""
echo "â¹ï¸  à¸à¸” Ctrl+C à¹€à¸žà¸·à¹ˆà¸­à¸«à¸¢à¸¸à¸”à¸£à¸°à¸šà¸š"

# à¸£à¸­à¹ƒà¸«à¹‰à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸à¸” Ctrl+C
trap "echo ''; echo 'ðŸ›‘ à¸«à¸¢à¸¸à¸”à¸£à¸°à¸šà¸š...'; kill $BACKEND_PID 2>/dev/null; exit 0" INT

# à¸£à¸­à¹ƒà¸«à¹‰ backend à¸—à¸³à¸‡à¸²à¸™
wait $BACKEND_PID
